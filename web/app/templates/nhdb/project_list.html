{% extends "object_list.html" %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% load crispy_forms_tags %}

{% block title %}{{block.super}} Projects {% endblock title %}

{% block script %}
    {{block.super}}
<script src="{{ STATIC_URL }}leaflet-place-selector.js"></script>
<script src="{{ STATIC_URL }}js/jquery.blueimp-gallery.min.js"></script>
<script>
    {% autoescape off %}
    var object_list = {{object_index}}
{% endautoescape  %}
</script>

<script>
$(document).ready(function () {
    $(document).on('click', 'input.changelocations', function () {
        $('#map img').remove();
        // createMap function, from leaflet-location-setter, dynamically replaces a #map on the page with an 'editable' map
        createMap();
        $(this).attr('disabled', 'disabled');
        $(document).off('submit', 'form#update-projectplace').on('submit', 'form#update-projectplace', function (e) {
            e.preventDefault();
            returns = [];
            $.map(globalLayers, function (e, i) {
                returns.push({
                    "project": window.object(),
                    "place": globalLayers[i][0].feature.properties.pcode
                })
            });
            $(this).find('[name=data]').val(JSON.stringify({'projectplace_set': returns}));
            var xhr = $.post('/suggest/suggest/', $(this).serializeArray());
            if (xhr.success){
              if ($.isFunction($.simplyToast)) {

                $.simplyToast('<p><b>Suggestion Received</b></p><p>The database team will review your change soon!</p>');
              } else {
                console.log('simplyToast function is not available');
              }}

        })
    });
});



$(document).ready(function () {

    $('#toggle-object-list').on('click', function(){
    $('#object-list').css({position:'relative'}).animate({
  left: '-100%',
  position: 'relative',
  zIndex: '-1',
  opacity: '0'
})})
     })



</script>
{% endblock script %}

 {% block style %}


    {{block.super}}

    <!--<script type="text/javascript" src="{{ STATIC_URL }}flot/jquery.flot.js"></script>-->
    <!--<script type="text/javascript" src="{{ STATIC_URL }}flot/jquery.flot.time.js"></script>-->
    <!--<script type="text/javascript" src="{{ STATIC_URL }}flot/jquery.flot.axislabels.js"></script>-->

    <link href="{{ STATIC_URL }}leaflet/leaflet.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ STATIC_URL }}css/blueimp-gallery.min.css">

    <style>
        .projectimage-container{
            position:relative;
        }

        .projectimage-container .projectimage-toolbar{
            display:none;
        }

        .projectimage-container:hover .projectimage-toolbar{
            display:block;
        }


        .projectimage-toolbar{
            position:absolute;
            bottome:2px;
            right:2px;
        }


    </style>
{% endblock style %}

{% block modals %}
{{block.super}}
<div id="imagemodal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Image</h4>
      </div>
      <div class="modal-body">
        <p><img src=""></p>
          <p class="description"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <a href="/nhdb/projectimage/" class="btn btn-default edit-image">Edit image</a>
      </div>
    </div>
  </div>
</div>

<div id="leafletmodal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Locations</h4>
            </div>
        <div class="modal-body">

        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <a href="/nhdb/projectimage/" class="btn btn-default edit-image">Edit image</a>
            </div>
        </div>
    </div>
</div>


{% comment %}
This is a special case modal for a suggestion to add a PERSON who does not yet exist to a project.
As this requires two submissions (one to create the person; another to create the link to the project)
some additional javascript code is required
{% endcomment %}

<div id="new-person-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Enter a new person to the database</h4>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="modal-form-new-person" type="button" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>


{% endblock modals %}

{% block leftsidelist %}

    <form class="search-form form-horizontal">
        <div class="container-fluid">
            <div class="row">

    <div class="form-group">
        <label for="search-form-activities" class="col-sm-3 control-label">Activities</label>
        <div class="col-sm-9">
            <select style="width:100%;" id="search-form-activities" class="auto-select2" name="q" multiple=multiple>{% for a in filters.act %}
                <option value="{{a.path}}" {% if a.path in activefilters %}selected{%endif%}>{{a}}</option> {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="search-form-beneficiaries" class="col-sm-3 control-label">Beneficiaries</label>
        <div class="col-sm-9">
            <select style="width:100%;" id="search-form-beneficiaries" class="auto-select2" name="q" multiple=multiple>{% for a in filters.ben %}
                <option value="{{a.path}}" {% if a.path in activefilters %}selected{%endif%}>{{a}}</option> {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="search-form-sectors" class="col-sm-3 control-label">Sectors</label>
        <div class="col-sm-9">
            <select style="width:100%;" id="search-form-sectors" class="auto-select2" name="q" multiple=multiple>{% for a in filters.inv %}
                <option value="{{a.path}}" {% if a.path in activefilters %}selected{%endif%}>{{a}}</option> {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="search-form-district" class="col-sm-3 control-label">District</label>
        <div class="col-sm-9">
            <select style="width:100%;" id="search-form-district" class="auto-select2" name="q" multiple=multiple>{% for a in filters.district %}
                <option value="{{a.value}}" {% if a.value in activefilters %}selected{%endif%}>{{a.label}}</option> {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="search-form-status"  class="col-sm-3 control-label">Status</label>
        <div class="col-sm-9">
            <select style="width:100%;" id="search-form-status" class="auto-select2" name="q" multiple=multiple>{% for a in filters.status %}
                <option value="{{a.value}}" {% if a.value in activefilters %}selected{%endif%}>{{a.label}}</option> {% endfor %}
            </select>
        </div>
    </div>


    <div class="form-group">
        <label for="search-form-organization"  class="col-sm-3 control-label">Org(s)</label>
        <div class="col-sm-9">
            <select style="width:100%" name="org" id="search-form-organization" data-selecturl="/selecttwo/nhdb/organization/name/icontains/" multiple="multiple">
                {% for i in organization %}
                <option value="{{i.pk}}" selected>{{i}}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="search-form-text"  class="col-sm-3 control-label">Text</label>
        <div class="col-sm-9">
            <input style="width:100%" id="search-form-text" class="form-control" name="text" value="{{text}}">
        </div>
    </div>

<div class="col-sm-12">



<button class="btn btn-block">Search</button>
</div>
</div>
</div>
</form>

{% endblock %}

{% block list %}
<h3>
    {% if not organization %}{{object_list.count}} Projects{% endif %}
    {% if organization %}Projects of {{organization}} ({{object_list.count}}){% endif %}
</h3>

<div class="container-fluid">
    <div class="row">

        <div class="col col-lg-12 col-xs-12" id="actions-container">
            <a href="table/?{{ request.GET.urlencode }}" class="btn btn-default btn-sm">Contact list</a>
            <a href="xls/?{{ request.GET.urlencode }}" class="btn btn-default btn-sm">Contact list as Excel download</a>
        </div>

        <div class="col col-lg-12 col-xs-12" id="pagination-container">
          <ul class="pagination pagination-sm">
            <li><a href="#" data-page='previous' aria-label="Previous"><span aria-hidden="true">«</span></a></li>
            <li><a href="#" aria-label="CurrentPage">Page <span data-currentpage="">1</span> of <span data-pages="">y</span></a></li>

              <li><a href="#" data-page='next' aria-label="Next"><span aria-hidden="true">»</span></a></li>
          </ul>
        </div>

        <div class="col col-lg-12 col-xs-12" id="object-list-container">
            <ul class="list-group" id="object_list">{% for object in object_list %}
                <li class="object list-group-item"><a href="#object={{object.pk}}"><p>{{object}}</p></a>{% if object.description %}<p class="small">  {{object.description}}</p>{%endif %}</li>{% endfor %}
            </ul>
        </div>

    </div>

</div>
{% endblock list %}

{% block objectlist %}
<div id="object-list" class="collapse in">
    <div>
        <a href="table/?{{ request.GET.urlencode }}" class="btn btn-default btn-sm">Show as Table</a>
        <a href="xls/?{{ request.GET.urlencode }}" class="btn btn-default btn-sm">Download Table (Excel)</a>
        {% render_table table %}
    </div>
</div>
{% endblock %}

{% block dashboard %}
    <h4>Project Search</h4>
     <p><strong>{{object_list.count}} Projects</strong> found with this search</p>

     <div class="container-fluid"><div class="row">

     {% for category, tag_count in dashboard.items %}<div class="col col-sm-6 col-xs-12 col-md-4 col-lg-3">
             <table class="table table-condensed">
            <caption>{{category}}</caption>
            <tbody>
        {% for tag, count in tag_count.items %}

            <tr>{% if tag.path in activefilters %}
                <td><strong>{{tag}}</strong></td> <td><strong>{{count}}</strong></td>
                {% else %}
                <td>{{tag}}</td> <td>{{count}}</td>
                {% endif %}
            </tr>

     {% endfor %}

                    </tbody>
        </table>
     </div>{% endfor %}</div></div>

{% endblock %}