<search-input>
    <label>{opts.label}
        <input ref="input" oninput="{oninput}" placeholder="{opts.placeholder}">
    </label>
    <script>
        var tag = this;
        tag.oninput = function(e){
            var val = tag.refs.input.value;
            if (val === ''){
                tag.parent.trigger('unset_filter', tag.opts.index, tag.opts.func);
                return;
            }
            if (opts.int){val = _.toInteger(val)}
            tag.parent.trigger('set_filter', tag.opts.index, tag.opts.func, val)
        }

    </script>
</search-input>

<search-choice>
    <label>{opts.label}</label>
    <!--
        <input class="form-control" placeholder="Search" ref="searchbox" oninput="{search}" onfocus="{show_dropdown}">
        <virtual if="{i_am_visible}">
            <select class="form-control" multiple={opts.multiple} onchange="{onselect}" ref="input" oninput="{oninput}">
                <option value="">All</option>
              <option each="{option in choice}" value="{option.pk}">{option.name}</option>
            </select>
        </virtual>
    -->

    <div class="dropdown {open:dropdown_open}">

        <button class="buttontext btn btn-block btn-default dropdown-toggle" type="button" onclick="{toggle_dropdown}" disabled="{opts.is_disabled}">
            <span>{ opts.label }: {_.size(selected_choices) > 1 ? '('+_.size(selected_choices)+')' : ''} { selected || 'All' }</span>
            <span if="{opts.show_code}" class="small"></span>
            <span class="right"><span class="caret"></span></span>
        </button>

        <ul if="{dropdown_open}" class="dropdown-menu">
            <li>
                <div class="input-group search">
                    <input type="text" class="form-control" placeholder="{opts.placeholder|| 'Search for...'}" ref="searchbox" oninput="{ search }">
                    <div class="input-group-addon"><span class="glyphicon glyphicon-search"></span></div>
                </div><!-- /input-group -->
            </li>

            <li each="{option in choice}" onclick="{cowsay}">
                <span class="btn btn-link">
                    {option.name}
                </span>
            </li>
        </ul>
    </div>

    <style>
        .buttontext {
          width: 95%;
          overflow: hidden;
          white-space: nowrap;
          display: block;
          text-overflow: ellipsis;
        }â€‹
    </style>


    <script>
        var tag = this;
        tag.selected_choices = tag.opts.selected_choices || [];

        tag.cowsay = function cowsay(e){tag.onselect(e.item.option);};
        /**
         * Toggle dropdown options open or cloded
         */
        function toggle_dropdown() {

            if (tag.dropdown_open === false) {
                tag.update({dropdown_open: true});
                tag.one('updated', function () {
                    $('input[ref="searchbox"]', tag.root).focus();
                });
            } else {
                tag.update({dropdown_open: false});
            }
        }
        tag.toggle_dropdown = toggle_dropdown;


        function make_options(option){
            var name;
            var choice;
            if ( _.isUndefined(option.name)){ name = '?'}
            else name = option.name.en || option.name.tet || option.name.name || option.name ||  '?';
            choice = {pk: option.pk, name: name};
            if (_.includes(tag.selected_choices , choice)){choice.active=true}
            return choice
        }

        tag.on('before-mount', function() {
            tag.dropdown_open = false;

            var related_table = tag.opts.related_table;

            if (_.isUndefined(related_table)){console.warn('Related_table is undefined')}
            if (!_.isFunction(related_table.toArray)) {return {}} // This is NOT a table probalbly

            related_table.toArray().then(function (choice) {
                if (!_.isUndefined(tag.opts.number_of_choices) && _.size(choice) > _.toInteger(tag.opts.number_of_choices))
                { debugger; choice = _.slice(choice,0,_.toInteger(tag.opts.number_of_choices))}
                var choices = _.map(choice, make_options);
                tag.update({choice: _.compact(choices)})
            })
        });

        tag.search = function(e){

            console.log(tag.refs.searchbox.value);
            tag.opts.related_table.where(tag.opts.index)
                .startsWithIgnoreCase(tag.refs.searchbox.value).toArray().then(function(choice){
                    var choices = _.map(choice, make_options);
                    // Things get interesting here with multiple languages
                    // Hence , 'uniqBy'
                    choices =  _.compact(_.uniqBy(choices, 'pk'));
                    tag.update({choice: choices})
            })
        };

        tag.onselect = function(choice){
            var selected = _.includes(tag.selected_choices, choice);
            if (!tag.opts.multiple){
                _.each(tag.selected_choices, function(c){c.active = false});
                tag.selected_choices = []}
            if (selected) {choice.active = false; _.pull(tag.selected_choices, choice)}
            else {choice.active = true; tag.selected_choices.push(choice)}

            var trigger = tag.parent.trigger;
            var opts = tag.opts;

            var i = opts.filter_table_index; // Which index on the target table to filter on
            var cb = opts.func; // Callback function on selection
            var cast_int = opts.int; // Should we expect all values to be integers (ie index key type)
            var multi = opts.multiple; // Should we have multiple options (ie array)
            var val =  _.map(tag.selected_choices, 'pk');

            // Coercion and casting of types to integer
            if (!multi && cast_int){val = _.toInteger(val)}
            if (multi && cast_int){val = _.map(val, _.toInteger)}
            if (multi){val = _.compact(val)}

            function set(val){trigger('set_filter' , i, cb, val) }
            function unset(){trigger('unset_filter', i, cb);}
            function do_unset(){ // "Unset" filter if an empty-is value is given
                if (!multi && val === '') { return true;}
                if (multi && _.size(val) === 1 && val[0] === ""){return true}
                if (multi && _.size(val) === 0){return true}
            }

            if (do_unset()) {unset();}
            else {set(val)}
            return tag.update({selected: _(tag.selected_choices).map('name').join(', ')});
        };

    </script>
</search-choice>

<project-app>
    <div hide="{detail}" class="col col-sm-4">
        <h3>Filter</h3>
        <span data-is="search-choice"
              multiple="1"
              label="Beneficiary"
              int=true
              func="anyOf"
              index="searchIndex"
              filter_table_index="beneficiary_s"
              filter_table="{db.Project}"
              related_table="{db.Beneficiary}"
        ></span>

        <span data-is="search-choice"
              multiple=1
              label="Sector"
              int=true
              func="anyOf"
              index="searchIndex"
              filter_table_index="sector_s"
              filter_table="{db.Project}"
              related_table="{db.Sector}"
        ></span>

        <span data-is="search-choice"
              multiple=1
              label="Activity"
              int=true
              func="anyOf"
              index="searchIndex"
              filter_table_index="activity_s"
              filter_table="{db.Project}"
              related_table="{db.Activity}"
        ></span>

        <span data-is="search-choice"
              multiple=1
              label="Organizations"
              int=true
              func="anyOf"
              index="name"
              filter_table_index="orgs"
              filter_table="{db.Project}"
              related_table="{db.Organization}"
              number_of_choices=100
        ></span>



        <span data-is="search-input" label="Name" placeholder="By Name" func="startsWithIgnoreCase" index="name"></span>

    </div>
    <div hide="{detail}" class="col col-sm-8">
        <h3>List of Projects</h3>
        <project-list ref="project_list" table="{db.Project}"></project-list>
    </div>

    <div if="{detail}" class="col col-sm-12">
        <h3>Project Detail</h3>
        <project-detail ref="project_detail" table="{db.Project}" pk="{}"></project-detail>
    </div>

    <script>
        var tag = this;

        tag.on('set_filter', function(index, func, param){
            var list = tag.refs.project_list;
            list.filters.set(index, func, param);
            list.trigger('refresh_list');
        });

        tag.on('unset_filter', function(index, func){
            var list = tag.refs.project_list;
            list.filters.unset(index, func);
            list.trigger('refresh_list');
        })

    </script>

</project-app>

<project-list>
    <h5>Hello World</h5>
    Object {filters.offset + 1} to {filters.offset + filters.limit + 1} of { filters.count }
        <table if={!loading} class='table table-condensed table-bordered table-striped'>
            <thead>
                <tr>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr onclick="{detail}" each="{project in projects}">
                    <td>{project.name}</td>
                    <td> <span each="{ sector in project.sector_s }" sector="{sector}" table="{db.Sector}" property="name.en" data-is="sector-name"></span></td>
                    <td> <span each="{ sector in project.beneficiary_s }" sector="{sector}" table="{db.Beneficiary}" property="name.en" data-is="sector-name"></span></td>
                    <td> <span each="{ sector in project.activity_s }" sector="{sector}" table="{db.Beneficiary}" property="name.en" data-is="sector-name"></span></td>

                    <td>{project.startdate}</td>
                </tr>
            </tbody>
        </table>

        <button onclick="{page.up}"> Up </button>
        <button onclick="{page.down}"> Down </button>

    <style>
        h5 {color: blue;}

    </style>

    <script type="text/javascript">
        var tag = this;
        tag.mixin('tableFilterMixin');

        tag.table = window.db.Project;
        tag.one('mount', function () {
            tag.filters.limit = tag.opts.limit || tag.filters.limit;
            tag.filters.offset = tag.opts.offset || tag.filters.offset;
            tag.trigger('refresh_list');
        });
        tag.on('refresh_list', function (opts) {
            _.extend(tag.filters, opts);
            var promiseArray = tag.filters.results();
            console.log(tag.filters)
            promiseArray.then(function(project_list) {tag.update({loading: false, projects: project_list})})
        });

        tag.page = {};
        tag.page.up = function () {tag.trigger('refresh_list', {offset: tag.filters.offset + tag.filters.limit})};
        tag.page.down = function () {tag.trigger('refresh_list', {offset: tag.filters.offset - tag.filters.limit})};

        tag.detail = function(e){
              tag.opts.table.get(_.toInteger(e.item.project.pk)).then(function(detail){
              tag.parent.update({detail: detail})
          }
              )}
    </script>
</project-list>
<project-detail>

    <p>{parent.detail.id}</p>
    <p>{parent.detail.name}</p>
    <button onclick="{list}">Back to list</button>
    <script>
        var tag = this;
    tag.list = function(){
        tag.parent.update({detail:false})
    }
    </script>
</project-detail>

<sector-name>
    <p if="{!s}">Looking up</p>
    <p if="{s}">{s}</p>
    <script>
        var tag =this;
        tag.on('before-mount', function(){
            var table = tag.opts.table || db.PropertyTag;
            var property = tag.opts.property || 'name';
            if (!tag.opts.table){tag.update({s:"Missing Table"}); return}
            tag.opts.table.get(_.toInteger(tag.opts.sector)).then(function(s){
                tag.update({s:_.get(s, property)})})
        });
    </script>
</sector-name>